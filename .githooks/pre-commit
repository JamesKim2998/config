#!/bin/bash
# Pre-commit hook: verify nvim starts without errors
# Only runs when nvim config files are staged

staged=$(git diff --cached --name-only)
if ! echo "$staged" | grep -q '^nvim/'; then
  exit 0
fi

sock="/tmp/nvim-precommit-$$.sock"
errfile="/tmp/nvim-precommit-$$.err"

cleanup() {
  if [ -n "$pid" ] && kill -0 "$pid" 2>/dev/null; then
    kill "$pid" 2>/dev/null
    wait "$pid" 2>/dev/null
  fi
  rm -f "$sock" "$errfile" "$errfile.msg"
}
trap cleanup EXIT

# Start headless nvim and wait for socket
nvim --headless --listen "$sock" -n /dev/null 2>"$errfile" &
pid=$!
for _ in $(seq 1 30); do
  [ -S "$sock" ] && break
  sleep 0.1
done
sleep 0.5  # let plugins finish loading

# Capture :messages output
nvim --server "$sock" --remote-expr 'execute("messages")' > "$errfile.msg" 2>/dev/null
nvim --server "$sock" --remote-send ':qa!<CR>' 2>/dev/null
wait "$pid" 2>/dev/null
pid=""

# Check stderr for errors
if grep -qi 'error\|E5107\|Failed to' "$errfile" 2>/dev/null; then
  echo "pre-commit: nvim startup error (stderr):"
  cat "$errfile"
  exit 1
fi

# Check :messages for errors
if grep -qi 'Failed to\|Error detected\|E5107' "$errfile.msg" 2>/dev/null; then
  echo "pre-commit: nvim startup error (:messages):"
  cat "$errfile.msg"
  exit 1
fi
